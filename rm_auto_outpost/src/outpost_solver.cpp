/*                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                  
                                               ,]]@@@@@@@@@@@@@@@\]]`                                                                                                                                  
                                        ,]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\].                                                                                              /@\                          
                                   .]@@@@@@@@@@@[[`              .[[\@@@@@@@@@\`                                                             /@\                        .@@@^                          
                                ,@@@@@@@@/[                              ,[@@@@@@@\`                                                       =@@@^                       ,@@@^                           
                             ,@@@@@@@[.   ,]]@@@@@@@@@@@@@@@@@]               ,\@@@@@\`                                                  .@@@@`                       ,@@@/                            
                          ./@@@@@/`  ,@@@@@@@@@@@@@@@@@@@@@@@@@@^                 [@@@@@]                                               =@@@@.                       .@@@/                             
                        ,@@@@@@`     \@@@[[[`             =@@@@@^                    [@@@@\                                            /@@@/                         @@@@.                             
                      ,@@@@@/                            /@@@@[                        .\@@@\                                        .@@@@/                         /@@@^                              
                    ./@@@@/                            ,@@@@`                             \@@@\                                     ,@@@@^                         =@@@/          ]]`                  
                   =@@@@/                             ,@@@@.                                \@@@`                                  ,@@@@`                         ,@@@@.      .]@@@@@^                 
                 .@@@@@`                             ,@@@@                                   .@@@\                                =@@@@.                          @@@@@]]@@@@@@@@@/`                   
                ,@@@@/                              ,@@@@                                      =@@\                              /@@@/                         .]/@@@@@@@@@@@@[`                       
               ,@@@@`                              ,@@@@.                                       ,@@@                            /@@@/                 .]]@@@@@@@@@@@@@@@[`                             
              ,@@@@.                              .@@@@.                                         .@@@                          /@@@^             ,/@@@@@@@@@@@@@@@@@/                                  
             ,@@@@.                               /@@@`                                           .@@\                        /@@@^              =@@@@@@[[`    /@@@@                                   
             @@@@.                               =@@@^        .]]@@@@@@@@@\                        ,@@^                     ,@@@@`                            ,@@@@`                                   
            =@@@^                               =@@@@ .]]@@@@@@@@@@@@@@@@@@                         =@@                    =@@@@`                             @@@@^                                    
           .@@@/                              ,/@@@@@@@@@@@@@@@@[[[.                                 \@^                  /@@@@.    =@@@                     =@@@/                                     
           =@@@.   ,]@@@@@@@@@@]]]]]]]@@@@@@@@@@@@@@@@@[`                                            ,@@                 /@@@/      @@@@                    ,@@@@                                      
          .@@@/./@@@@@@@@@@@@@@@@@@@@@@@@@@@/[@@@@@.                                                  \@^              .@@@@/      .@@@@                    @@@@`                                      
          =@@@@@@@@@[`       ,[\@@@@@@@@@]   =@@@@`                                                   =@^             ,@@@@/       =@@@@                   =@@@^                                       
          @@@@@@@/                 .[@@@@@@@]@@@@^                                                     @^            ,@@@@/        =@@@^                  .@@@@                                        
          @@@@@@`                      .\@@@@@@@/                                             ^        @^           ,@@@@/         @@@@^                  /@@@`  ,@@`                                  
          @@@@@`                           \@@@@@\`                                           ^        @^          ,@@@@@          @@@@^                 =@@@^   @@@@`                                 
          @@@@^                            @@@@@@@@@@@@@@@@`                                  O        @^         .@@@@@.          @@@@                  @@@@    @@@@^     ,]]]/@@@@@@]].              
          @@@@^                           =@@@^ \@@@@@@@@@@@@`                                @        @          @@@@@           ,@@@@`                =@@@^    @@@@@ /@@@@@@@@@@@@@@@@@@@\`          
          @@@@^                          .@@@@    ,@@@@@@@@@@@@`                              @       =/         =@@@@@.          =@@@@.               ,@@@/     @@@@@=@@@@@@[[[[[[[[..\@@@@@\         
          =@@@^                          /@@@`      ,@@@@@@@@@@@@`                           =/       =`         @@@@@@.          =@@@/                @@@@.     @@@@@.                  @@@@/         
          =@@@@                         =@@@^         .\@@@@@@@@@@\.                         =^       ^          =@@@`            =@@@^               =@@@^      @@@@@@                  @@@@@         
           @@@@^                        @@@@            .\@@@@@@@@@@^                       .@       ,                            =@@@`              .@@@@        @@@@@                 =@@@@`         
           =@@@@                       =@@@`               \@@@@@@@@@@.                     /^                               .*[[[@@@@               /@@@^        @@@@@                /@@@@`          
            \@@@^                     .@@@/                  \@@@@@@@@@`                   =@                                     @@@@ [\@].        ,@@@@         @@@@@              .@@@@@`           
             @@@@^                    =@@@.                    [@@@@@@@@^                 ,@`                                     @@@@     [@]      @@@@`         @@@@@             ,@@@@/             
              @@@@^                  ,@@@^                       ,@@@@@@@`               =@`                                      @@@@       ,@`   =@@@/          @@@@@           /@@@@@`              
               \@@@\                 /@@@.                         ,@@@@@@.             /@`                                       @@@@        ,@` .@@@@.          @@@@@        ,@@@@@@`                
                \@@@@`              ,@@@/                            @@@@@@@`         .@@`                                       .@@@\         @^ =@@@^           @@@@@      /@@@@@@`                  
                 ,@@@@\.            /@@@^                             @@@@@@@@\`     /@/                                         =@@@@.        @^,@@@@.           @@@@@    ,@@@@@@@@]                  
                   ,@@@@\.         ,@@@@                              ,@@@@@@@@@@\.,@@`                                          =@@@@        /@`/@@@^            @@@@@    \@@@@@@@@@@@@\`             
                     ,@@@@@`       =@@@^                                 @@@@@@@@@\`                                         		 =@@@@      ,@@`,@@@@             @@@@@      .[@@@@@@@@@@@.            
                       ,@@@@@\.    @@@@^                                   @@@@@@@@@@@                                  			   =@@@@    ]@@/  /@@@^             @@@@@                                
                          \@@@@@\`=@@@@`                                    @@@@@@@@@@                               					   =@@@@^]@@@`   .@@@@              @@@@@                               
                            .[@@@@@@@@@`                                ,/@@@@/@@@@@@@@\]                          						   =@@@@@@`      @@@@@              @@@@@                               
                                ,\@@@@@@@\]`                             /@@@@@@/ @@@@@@@@@].       											       @@@@@@^      @@@@@^              @@@@@                               
                                     \@@@@@@@@\                      /@@@@@@@@/   	\@@@@@@@@@\                           	   /@@@@@@/                            @@@                                              
                                         \@@@@@@@@\            /@@@@@@@@@@/        		\@@@@@@@@@@\                   		  /@@@@@@/                                 @@                                      
                                                 \@@@@@@@@@@@@@@@@/                    \@@@@@@@@@@@@\          		 /@@@@@@@@@/                                                                                                      
                                                                                          \@@@@@@@@@@@@\ 		/@@@@@@@@@/                                                                                                    
																																																	\@@@@@@@@@@@@/                                                                                                                                                    
                                                                                                                                                                                                                                                                      
                                                                                                                                                          .]]]]]]]]]]]..                                                     .]]]/@@@@^                               
     =@@@@@@@@@@@@@@@@@`                @@@@@@@@@@@@@@@@@\                                       /@@@@@@@@@@@@@@O                                  .]/@@@@@@@@@@@@@@@@@@@@@@@@O]].                                     O@@@@@@@@@@@@@@@^                              
     =@@@@@@@@@@@@@@@@@.                O@@@@@@@@@@@@@@@@@@.                                    /@@@@@@@@@@@@@@@^                               ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\].                              =@@@@@@@@@@@@@@@@@`                             
     =@@@@@@@@@@@@@@@@@.                =@@@@@@@@@@@@@@@@@@@.                                  /@@@@@@@@@@@@@@@@^                            ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\                          ,@@@@@@@@@@@@@@@@@@@.                            
     ,@@@@@@@@@@@@@@@@@                 =@@@@@@@@@@@@@@@@@@@@`                                =@@@@@@@@@@@@@@@@@^                          /@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^                          @@@@@@@@@@@@@@@@@@@@\                            
     .@@@@@@@@@@@@@@@@@                 =@@@@@@@@@@@@@@@@@@@@@^                              =@@@@@@@@@@@@@@@@@@^                        /@@@@@@@@@@@@@@@[.     .[[\@@@@@@@@@@@@@@@@@@@@@^                          =@@@@@@@@@@@@@@@@@@@@@^                           
     .@@@@@@@@@@@@@@@@@                 .@@@@@@@@@@@@@@@@@@@@@@\                            =@@@@@@@@@@@@@@@@@@@^                      ,@@@@@@@@@@@@@@`                .[@@@@@@@@@@@@@@@@.                         ,@@@@@@@@@@@@@@@@@@@@@@@^                          
      @@@@@@@@@@@@@@@@O                 .@@@@@@@@@@@@@@@@@@@@@@@\                          ,@@@@@@@@@@@@@@@@@@@@^                    ./@@@@@@@@@@@@@^                      .[@@@@@@@@@@@`                         .@@@@@@@@@@@@@@@@@@@@@@@@@`                         
      @@@@@@@@@@@@@@@@/                  @@@@@@@@@@@@@@@@@@@@@@@@@.                       ,@@@@@@@@@@@@@@@@@@@@@^                   ,@@@@@@@@@@@@@@`                           [@@@@@@@^                          /@@@@@@@@@@@@@@@@@@@@@@@@@@.                        
      @@@@@@@@@@@@@@@@^                  O@@@@@@@@@@@@@@@@@@@@@@@@@`                     .@@@@@@@@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@@.                              .\@@@@                          =@@@@@@@@@@@@@@@@@@@@@@@@@@@\                        
      O@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@@@@@@@@@@@@@@^                   .@@@@@@@@@@@@@@@@@@@@@@@^                 =@@@@@@@@@@@@@@.                                 .\@`                         .@@@@@@@@@@@@@^@@@@@@@@@@@@@@@^                       
      \@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@,@@@@@@@@@@@@@^                 .@@@@@@@@@=@@@@@@@@@@@@@@^                ,@@@@@@@@@@@@@@`                                                               /@@@@@@@@@@@@^ .@@@@@@@@@@@@@@@^                      
      =@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@/ ,@@@@@@@@@@@@@\                /@@@@@@@@`=@@@@@@@@@@@@@@^               .@@@@@@@@@@@@@@^                                                               =@@@@@@@@@@@@`   .@@@@@@@@@@@@@@@`                     
      =@@@@@@@@@@@@@@@^                  ,@@@@@@@@@@@@^  =@@@@@@@@@@@@@@.             /@@@@@@@@` .@@@@@@@@@@@@@@^               O@@@@@@@@@@@@@@                                                               .@@@@@@@@@@@@`     ,@@@@@@@@@@@@@@@.                    
      =@@@@@@@@@@@@@@@^                  .@@@@@@@@@@@@.   =@@@@@@@@@@@@@@`           /@@@@@@@@^   @@@@@@@@@@@@@@^              =@@@@@@@@@@@@@@^                                                               /@@@@@@@@@@@.       ,@@@@@@@@@@@@@@\                    
      =@@@@@@@@@@@@@@@`                   @@@@@@@@@@@O     \@@@@@@@@@@@@@@`         =@@@@@@@@^    @@@@@@@@@@@@@@.              @@@@@@@@@@@@@@@                                                               =@@@@@@@@@@@.         ,@@@@@@@@@@@@@@^                   
      =@@@@@@@@@@@@@@@.                   O@@@@@@@@@@^      \@@@@@@@@@@@@@@^       =@@@@@@@@^     O@@@@@@@@@@@@@.             =@@@@@@@@@@@@@@^                                                              ,@@@@@@@@@@/            ,@@@@@@@@@@@@@@^                  
      =@@@@@@@@@@@@@@@.                   =@@@@@@@@@@.       O@@@@@@@@@@@@@@\     =@@@@@@@@/      O@@@@@@@@@@@@@.             /@@@@@@@@@@@@@@^                                                              @@@@@@@@@@/              =@@@@@@@@@@@@@@`                 
      ,@@@@@@@@@@@@@@@                    =@@@@@@@@@O        .@@@@@@@@@@@@@@@@.  ,@@@@@@@@/       =@@@@@@@@@@@@@.            .@@@@@@@@@@@@@@@`                                                             =@@@@@@@@@^                =@@@@@@@@@@@@@@.                
      .@@@@@@@@@@@@@@@                    =@@@@@@@@@^         .@@@@@@@@@@@@@@@@.,@@@@@@@@@.       =@@@@@@@@@@@@@             ,@@@@@@@@@@@@@@@.                                                            ,@@@@@@@@@^                  =@@@@@@@@@@@@@\                
      .@@@@@@@@@@@@@@@                    =@@@@@@@@@`          ,@@@@@@@@@@@@@@@@@@@@@@@@@.        =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@`                                                            @@@@@@@@@`                    =@@@@@@@@@@@@@^               
       @@@@@@@@@@@@@@O                    .@@@@@@@@@            ,@@@@@@@@@@@@@@@@@@@@@@@`         =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@^                                                           =@@@@@@@@`                      \@@@@@@@@@@@@@^              
       @@@@@@@@@@@@@@^                     @@@@@@@@^             =@@@@@@@@@@@@@@@@@@@@@`          =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@^                                                          ,@@@@@@@@.                        \@@@@@@@@@@@@@`             
       @@@@@@@@@@@@@@^                     O@@@@@@@^              =@@@@@@@@@@@@@@@@@@@^           .@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@@                                                         .@@@@@@@@@@@@\]]`.                  \@@@@@@@@@@@@@.            
       O@@@@@@@@@@@@@^                     =@@@@@@@                =@@@@@@@@@@@@@@@@@^             @@@@@@@@@@@@@             =@@@@@@@@@@@@@@@@^                                                        /@@@@@@@@@@@@@@@@@@@@@@@@@\]]`.      @@@@@@@@@@@@@\            
       \@@@@@@@@@@@@@^                     =@@@@@@^                 \@@@@@@@@@@@@@@@^              @@@@@@@@@@@@O             .@@@@@@@@@@@@@@@@@                                                       =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^           
       =@@@@@@@@@@@@@^                     =@@@@@@^                  \@@@@@@@@@@@@@/               O@@@@@@@@@@@O              \@@@@@@@@@@@@@@@@^                                                     .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/[@@@@@@@@@@@@@`          
       =@@@@@@@@@@@@@^                     =@@@@@@.                  .@@@@@@@@@@@@/                \@@@@@@@@@@@O              .@@@@@@@@@@@@@@@@@^                                                    /@@@@@@@@@@@@@@@@@@@@@@@@@@O[[[.         .@@@@@@@@@@@@@.         
       =@@@@@@@@@@@@@^                     .@@@@@/                    .@@@@@@@@@@@.                =@@@@@@@@@@@^               ,@@@@@@@@@@@@@@@@@\                                                  =@@@@@@@@@@@@@@@@/[[`.                     .@@@@@@@@@@@@@         
       =@@@@@@@@@@@@@.                      @@@@@^                     ,@@@@@@@@@.                 =@@@@@@@@@@@^                ,@@@@@@@@@@@@@@@@@@`                                               .@@@@@O[[[.                                  ,@@@@@@@@@@@@\        
       =@@@@@@@@@@@@@.                      @@@@@.                      ,@@@@@@@`                  =@@@@@@@@@@@^                 .\@@@@@@@@@@@@@@@@@\.                                             O@@@@`                                        ,@@@@@@@@@@@@^       
       =@@@@@@@@@@@@@.                      \@@@O                        =@@@@@`                   =@@@@@@@@@@@^                   ,@@@@@@@@@@@@@@@@@@@`                                          =@@@@.                                          ,@@@@@@@@@@@@`      
       ,@@@@@@@@@@@@@                       =@@@^                         =@@@^                    ,@@@@@@@@@@@^                     ,@@@@@@@@@@@@@@@@@@@\.                                      ,@@@@.                                            ,@@@@@@@@@@@@.     
       .@@@@@@@@@@@@@                       =@@@`                          =@^                     .@@@@@@@@@@@^                       .[@@@@@@@@@@@@@@@@@@@\`                                   @@@/                                               =@@@@@@@@@@@@     
       .@@@@@@@@@@@@@                       =@@@                                                    @@@@@@@@@@@^                          .[@@@@@@@@@@@@@@@@@@@@\].                             =@@/                                                 =@@@@@@@@@@@\    
        @@@@@@@@@@@@O                       .@@^                                                    @@@@@@@@@@@^                              .[\@@@@@@@@@@@@@@@@@@@@\].                       ,@@^                                                   =@@@@@@@@@@@^   
        @@@@@@@@@@@@^                        @@^                                                    O@@@@@@@@@@^                                    ,[\@@@@@@@@@@@@@@@@@@@@O]`.               .@@`                                                     =@@@@@@@@@@@`  
        @@@@@@@@@@@@^                        @@                                                     \@@@@@@@@@@^                                           .,[[O@@@@@@@@@@@@@@@@@@@O]].       =@`                                                       \@@@@@@@@@@@. 
                                                                                                                                                                          ..,[[[[[[[[[[[`                                                                             
                                                                                                                                                                                                                                                                      

*/

#include "rm_auto_outpost/outpost_solver.hpp"
#include "rm_utils/logger/log.hpp"
#include <angles/angles.h>

namespace fyt::auto_outpost
{
    OutpostSolver::OutpostSolver()
    {
        trajectory_compensator_ = CompensatorFactory::createCompensator("ideal");
        trajectory_compensator_->iteration_times = 20;
        trajectory_compensator_->velocity = 15.8;
        trajectory_compensator_->gravity = 9.8;
        trajectory_compensator_->resistance = 0.001;

        outpost_interval = 800;
        have_detecte = false;
        get_center = false;
        waitingToshut = false;

        timeBias = 100;
        last_sleep_time = -1;

        camera_matrix = cv::Mat(3, 3, CV_64FC1, cv::Scalar::all(0));
        camera_matrix.ptr<double>(0)[0] = 2064.16287;
        camera_matrix.ptr<double>(0)[2] = 639.97973;
        camera_matrix.ptr<double>(1)[1] = 2065.93895;
        camera_matrix.ptr<double>(1)[2] = 495.08268;
        camera_matrix.ptr<double>(2)[2] = 1.0f;

        distortion_coefficients = cv::Mat(5, 1, CV_64FC1, cv::Scalar::all(0));
        distortion_coefficients.ptr<double>(0)[0] = -0.047961;
        distortion_coefficients.ptr<double>(1)[0] = 0.136410;
        distortion_coefficients.ptr<double>(2)[0] = 0.000901;
        distortion_coefficients.ptr<double>(3)[0] = -0.000062;

        projection_matrix = cv::Mat(3, 4, CV_64FC1, cv::Scalar::all(0));
        projection_matrix.ptr<double>(0)[0] = 2064.16287;
        projection_matrix.ptr<double>(0)[2] = 639.97973;
        projection_matrix.ptr<double>(1)[1] = 2065.93895;
        projection_matrix.ptr<double>(1)[2] = 495.08268;
        projection_matrix.ptr<double>(2)[2] = 1.0f;

        rvec = cv::Mat(3, 1, CV_64F, cv::Scalar::all(0));
        tvec = cv::Mat(3, 1, CV_64F, cv::Scalar::all(0));
        R_T_ = cv::Mat(4, 4, CV_64F, cv::Scalar::all(0));
        
    }

    rm_interfaces::msg::GimbalCmd OutpostSolver::solve(const rm_interfaces::msg::Armors::SharedPtr armors_msg,std::shared_ptr<tf2_ros::Buffer> tf2_buffer,const double IMU_pitch,const double IMU_yaw)
    {
        // double Camera_yaw, Camera_pitch;
        rm_interfaces::msg::GimbalCmd gimbal_cmd;
        gimbal_cmd.yaw = 0;
        gimbal_cmd.pitch = 0;
        gimbal_cmd.fire_advice = false;

        static cv::Point3d shootCenter = cv::Point3d(0,0,0);

        // if(get_center){
        //     for (auto a: armors_set) {
        //         shootCenter += cv::Point3d(a.x, a.y, a.z);
        //     }
        //     shootCenter = shootCenter / (int) armors_set.size();
        //     double yaw,pitch;
        //     Eigen::Vector3d target_position = {shootCenter.x, shootCenter.y, shootCenter.z};
        //     calcYawAndPitch(target_position, yaw, pitch);
        //     yaw = yaw * 180 / CV_PI;
        //     pitch = pitch * 180 / CV_PI;
        //     gimbal_cmd.yaw = yaw;
        //     // gimbal_cmd.pitch = pitch;
        //     gimbal_cmd.pitch = IMU_pitch - pitch;
        // }

        int dians_ = -1;
        if(!armors_msg->armors.empty()){
        
            auto target_armor = armors_msg->armors[0];

            dians_ = calculateDistanceToCenter(cv::Point2f(target_armor.pose_pic.position.x, target_armor.pose_pic.position.y)) * std::abs(target_armor.pose.position.x);
            // std::cout<<"dians_:"<<dians_<<std::endl;

            ArmorBlob a_;
            a_.x = target_armor.pose.position.x;
            a_.y = target_armor.pose.position.y;
            a_.z = target_armor.pose.position.z;
            armors_set.push_back(a_);

            if(armors_set.size()>31){
                armors_set.pop_back();
                auto max = std::max_element(armors_set.begin(), armors_set.end());
                armors_set.erase(max);
            }

        }

        // 获取现在的时间戳
        auto now = std::chrono::steady_clock::now();
        
        // cv::Mat m_R,m_T;
        // if(!armors_msg->armors.empty()){
        //     rvec.ptr<double>(0)[0] = target_armor.rvecx;
        //     rvec.ptr<double>(1)[0] = target_armor.rvecy;
        //     rvec.ptr<double>(2)[0] = target_armor.rvecz;
        //     cv::Rodrigues(rvec, m_R);

        //     tvec.ptr<double>(0)[0] = target_armor.tvecx;
        //     tvec.ptr<double>(1)[0] = target_armor.tvecy;
        //     tvec.ptr<double>(2)[0] = target_armor.tvecz;

        //     for(int i=0;i<3;i++){
        //         for(int j=0;j<3;j++){
        //             R_T_.ptr<double>(i)[j] = m_R.ptr<double>(i)[j];
        //         }
        //     }
        //     R_T_.ptr<double>(0)[3] = tvec.ptr<double>(0)[0];
        //     R_T_.ptr<double>(1)[3] = tvec.ptr<double>(1)[0];
        //     R_T_.ptr<double>(2)[3] = tvec.ptr<double>(2)[0];
        //     R_T_.ptr<double>(3)[3] = 0;
        // }

        for (auto a: armors_set) {
            shootCenter += cv::Point3d(a.x, a.y, a.z);
        }
        if (armors_set.size() != 0){
            shootCenter = shootCenter / (int) armors_set.size();
        }

        // std::cout<<"time.size():"<<time.size()<<std::endl;
        // std::cout<<"timeInZone.size():"<<timeInZone.size()<<std::endl;
        bool shootable = false;
        int sleep_time = -1;
        if(armors_set.size()>=30){
            if(!get_center){
                std::cout<<"拟合前哨站旋转中心:x="<<shootCenter.x<<"  y="<<shootCenter.y<<"  z="<<shootCenter.z<<std::endl;
            }
            get_center = true;
            double yaw,pitch;
            Eigen::Vector3d target_position = {shootCenter.x, shootCenter.y, shootCenter.z};
            calcYawAndPitch(target_position, yaw, pitch);
            yaw = yaw * 180 / CV_PI;
            pitch = pitch * 180 / CV_PI;
            gimbal_cmd.yaw = yaw;
            // gimbal_cmd.pitch = pitch;
            gimbal_cmd.pitch = IMU_pitch - pitch;
            flying_time = trajectory_compensator_->getFlyingTime(target_position);

            // geometry_msgs::msg::PoseStamped ps;
            // ps.header.stamp = armors_msg->header.stamp;
            // ps.header.frame_id = "odom";
            // ps.pose.position.x = shootCenter.x;
            // ps.pose.position.y = shootCenter.y;
            // ps.pose.position.z = shootCenter.z;
            // geometry_msgs::msg::PoseStamped center_armor;
            // center_armor.pose = tf2_buffer->transform(ps, "camera_optical_frame").pose;

            // ps.pose = target_armor.pose;
            // geometry_msgs::msg::PoseStamped tar_armor;
            // tar_armor.pose = tf2_buffer->transform(ps, "camera_optical_frame").pose;

            // cv::Point3f center3D = shootCenter;
            // cv::Point3f armor3D = cv::Point3f(target_armor.pose.position.x,target_armor.pose.position.y,target_armor.pose.position.z);

            // Eigen::MatrixXd e_p(3,4);
            // cv::cv2eigen(projection_matrix,e_p);
            // Eigen::Matrix4d e_r;
            // cv::cv2eigen(R_T_,e_r);
            // Eigen::Vector4d center_v;
            // center_v<<center3D.x,center3D.y,center3D.z,1;
            // Eigen::Vector4d armor_v;
            // armor_v<<armor3D.x,armor3D.y,armor3D.z,1;
            // auto temp1 = e_p * e_r * center_v;
            // auto temp2 = e_p * e_r * armor_v;

            // cv::Point2f shootCenter2D = cv::Point2f(temp1[0]/center3D.z,temp1[1]/center3D.z);
            // cv::Point2f armor2D = cv::Point2f(temp2[0]/armor3D.z,temp2[1]/armor3D.z);
            // std::cout<<"shootCenter2D:"<<shootCenter2D<<std::endl;
            // std::cout<<"armor2D:"<<armor2D<<std::endl;

            // double p = 0.8;
            // double distance = p * fabsf(shootCenter2D.x - armor2D.x) + (1 - p) * fabsf(shootCenter2D.y - armor2D.y);
            // double distance = p * fabsf(center3D.y - armor3D.y) + (1 - p) * fabsf(center3D.z - armor3D.z);
            gimbal_cmd.distance = dians_;
            // std::cout<<"distance:"<<distance<<std::endl;

            //拟合三块装甲板的时间差
            if(lostInShootZone >= 3 && !markLast){
                std::chrono::steady_clock::duration sum = std::chrono::steady_clock::duration::zero();
                for (const auto &timestamp: time) {
                    sum += timestamp.time_since_epoch();
                }
                if (time.size()) {
                    std::chrono::steady_clock::duration average = sum / time.size();
                    auto average_ms = std::chrono::duration_cast<std::chrono::milliseconds>(average);
                    timeInZone.push_back(average_ms);
                }
                time.clear();
                markLast = true;
            }

            double yaw_diff = std::fabs(IMU_yaw-yaw);
            double pitch_diff = std::fabs(IMU_pitch-pitch);
            // std::cout<<"yaw_diff:"<<yaw_diff<<std::endl;
            // std::cout<<"pitch_diff:"<<pitch_diff<<std::endl;
            // if(distance < 0.04){
            if(dians_ < 50 && yaw_diff<=5 && pitch_diff<=5){
                lostInShootZone = 0;
                markLast = false;
                time.push_back(now);

                if (timeInZone.size() >= 3) {
                    // 计算timeInZone相邻时间之间差值的平均值
                    std::chrono::steady_clock::duration sum = std::chrono::steady_clock::duration::zero();
                    sum = timeInZone[timeInZone.size()-1] - timeInZone[timeInZone.size()-3];
                    std::chrono::steady_clock::duration average = sum / 2; // 只用最近两个周期的时间进行拟合
                    auto average_ms = std::chrono::duration_cast<std::chrono::milliseconds>(average);
                    if(!waitingToshut){
                        shootable = true;
                    }
                    
                    if(average_ms.count()>950){
                        RCLCPP_INFO(rclcpp::get_logger("outpost_solver"),"average_ms:%ld",average_ms.count());
                        
                        if(last_sleep_time != -1){
                            sleep_time = last_sleep_time;
                        }
                        else{
                            shootable = false;
                        }
                        
                    }
                    else{
                        sleep_time = (int)(1.0 * average_ms.count() - flying_time * 1000);
                        last_sleep_time = sleep_time;
                    }
                    
                }
            }
            else if(dians_ > 100){
                lostInShootZone++;
            }
            // if( dians_< 200 ){
            //     shootable = true;
            // }
        }

        // 设置打弹
        if(shootable)
        {
            // std::cout<<sleep_time<<std::endl;
            waitingToshut = true;
            std::cout<<"成功触发,将在"<<sleep_time<<"ms之后发弹"<<std::endl;
            std::thread([this, sleep_time, &gimbal_cmd, &shootable]() {
                // 延迟击打
                std::this_thread::sleep_for(std::chrono::milliseconds(sleep_time));
                gimbal_cmd.fire_advice = true;
                waitingToshut = false;
                std::cout<<"fire !!!!!!!!!!!!!!!!!!!!"<<std::endl;
            }).detach();
        }

        // std::cout<<armors_msg->armors[0].selfyaw<<std::endl;

        // calcCameraYawAndPitch(Eigen::Vector3d{-armors_msg->armors[0].pose_camera.position.x, armors_msg->armors[0].pose_camera.position.z, -armors_msg->armors[0].pose_camera.position.y},
        //                       Camera_yaw,
        //                       Camera_pitch);

        // // 装甲板经过正中心则开始计算时间间隔准备发弹
        // if ((!have_detecte) && (Camera_pitch <= 1.5))
        // {
        //     if (abs(Camera_yaw) <= 0.25)
        //     {
        //         double yaw, pitch;
        //         Eigen::Vector3d target_position = {armors_msg->armors[0].pose.position.x, armors_msg->armors[0].pose.position.y, armors_msg->armors[0].pose.position.z};
        //         calcYawAndPitch(target_position, yaw, pitch);
        //         flying_time = trajectory_compensator_->getFlyingTime(target_position);
        //         gimbal_cmd.yaw = yaw;
        //         gimbal_cmd.pitch = pitch;
        //     }
        //     if (abs(Camera_yaw) <= 0.2)
        //     {
        //         have_detecte = true;
        //         start = std::chrono::steady_clock::now();
        //     }
        // }

        // double elapsed_ms = 3500;

        // if (have_detecte)
        // {
        //     end = std::chrono::steady_clock::now();
        //     elapsed_ms = std::chrono::duration<double, std::milli>(end - start).count();
        // }

        // if (AutoFireControl(elapsed_ms))
        // {
        //     gimbal_cmd.fire_advice = true;
        //     have_detecte = false;
        // }

        // if (elapsed_ms >= 4000 && have_detecte)
        // {
        //     have_detecte = false;
        // }

        return gimbal_cmd;
    }

    void OutpostSolver::calcCameraYawAndPitch(const Eigen::Vector3d &p, double &yaw, double &pitch) const noexcept
    {
        // Calculate Camera yaw and pitch
        yaw = atan2(p.y(), p.x());
        pitch = atan2(p.z(), p.head(2).norm());
    }

    void OutpostSolver::calcYawAndPitch(const Eigen::Vector3d &p,
                                        double &yaw,
                                        double &pitch) const noexcept
    {
        // Calculate yaw and pitch
        yaw = atan2(p.y(), p.x());
        pitch = atan2(p.z(), p.head(2).norm());

        if (double temp_pitch = pitch; trajectory_compensator_->compensate(p, temp_pitch))
        {
            pitch = temp_pitch;
        }
    }

    bool OutpostSolver::AutoFireControl(const double TimeDetecteToNow)
    {
        if (!have_detecte)
        {
            return false;
        }

        double All_FireDelay = outpost_interval + flying_time;
        if (abs(TimeDetecteToNow - All_FireDelay) <= 20)
        {
            return true;
        }
        return false;
    }

    void OutpostSolver::Init()
    {
        have_detecte = false;
        waitingToshut = false;
        time.clear();
        timeInZone.clear();
        armors_set.clear();
        last_sleep_time = -1;
    }

    double OutpostSolver::orientationToYaw(const geometry_msgs::msg::Quaternion &q) noexcept
    {
        // Get armor yaw
        tf2::Quaternion tf_q;
        tf2::fromMsg(q, tf_q);
        double roll, pitch, yaw;
        tf2::Matrix3x3(tf_q).getRPY(roll, pitch, yaw);
        // Make yaw change continuous (-pi~pi to -inf~inf)
        // yaw = last_yaw_ + angles::shortest_angular_distance(last_yaw_, yaw);
        // last_yaw_ = yaw;
        return yaw;
    }

    float OutpostSolver::calculateDistanceToCenter(const cv::Point2f &image_point) const noexcept {

        float cx = camera_matrix.at<double>(0, 2);
        float cy = camera_matrix.at<double>(1, 2);
        double p = 1;

        auto distance = p * std::fabs(image_point.x - cx) + (1-p) * std::fabs(image_point.y - cy);
        return distance;
    }

}