/*                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                  
                                               ,]]@@@@@@@@@@@@@@@\]]`                                                                                                                                  
                                        ,]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\].                                                                                              /@\                          
                                   .]@@@@@@@@@@@[[`              .[[\@@@@@@@@@\`                                                             /@\                        .@@@^                          
                                ,@@@@@@@@/[                              ,[@@@@@@@\`                                                       =@@@^                       ,@@@^                           
                             ,@@@@@@@[.   ,]]@@@@@@@@@@@@@@@@@]               ,\@@@@@\`                                                  .@@@@`                       ,@@@/                            
                          ./@@@@@/`  ,@@@@@@@@@@@@@@@@@@@@@@@@@@^                 [@@@@@]                                               =@@@@.                       .@@@/                             
                        ,@@@@@@`     \@@@[[[`             =@@@@@^                    [@@@@\                                            /@@@/                         @@@@.                             
                      ,@@@@@/                            /@@@@[                        .\@@@\                                        .@@@@/                         /@@@^                              
                    ./@@@@/                            ,@@@@`                             \@@@\                                     ,@@@@^                         =@@@/          ]]`                  
                   =@@@@/                             ,@@@@.                                \@@@`                                  ,@@@@`                         ,@@@@.      .]@@@@@^                 
                 .@@@@@`                             ,@@@@                                   .@@@\                                =@@@@.                          @@@@@]]@@@@@@@@@/`                   
                ,@@@@/                              ,@@@@                                      =@@\                              /@@@/                         .]/@@@@@@@@@@@@[`                       
               ,@@@@`                              ,@@@@.                                       ,@@@                            /@@@/                 .]]@@@@@@@@@@@@@@@[`                             
              ,@@@@.                              .@@@@.                                         .@@@                          /@@@^             ,/@@@@@@@@@@@@@@@@@/                                  
             ,@@@@.                               /@@@`                                           .@@\                        /@@@^              =@@@@@@[[`    /@@@@                                   
             @@@@.                               =@@@^        .]]@@@@@@@@@\                        ,@@^                     ,@@@@`                            ,@@@@`                                   
            =@@@^                               =@@@@ .]]@@@@@@@@@@@@@@@@@@                         =@@                    =@@@@`                             @@@@^                                    
           .@@@/                              ,/@@@@@@@@@@@@@@@@[[[.                                 \@^                  /@@@@.    =@@@                     =@@@/                                     
           =@@@.   ,]@@@@@@@@@@]]]]]]]@@@@@@@@@@@@@@@@@[`                                            ,@@                 /@@@/      @@@@                    ,@@@@                                      
          .@@@/./@@@@@@@@@@@@@@@@@@@@@@@@@@@/[@@@@@.                                                  \@^              .@@@@/      .@@@@                    @@@@`                                      
          =@@@@@@@@@[`       ,[\@@@@@@@@@]   =@@@@`                                                   =@^             ,@@@@/       =@@@@                   =@@@^                                       
          @@@@@@@/                 .[@@@@@@@]@@@@^                                                     @^            ,@@@@/        =@@@^                  .@@@@                                        
          @@@@@@`                      .\@@@@@@@/                                             ^        @^           ,@@@@/         @@@@^                  /@@@`  ,@@`                                  
          @@@@@`                           \@@@@@\`                                           ^        @^          ,@@@@@          @@@@^                 =@@@^   @@@@`                                 
          @@@@^                            @@@@@@@@@@@@@@@@`                                  O        @^         .@@@@@.          @@@@                  @@@@    @@@@^     ,]]]/@@@@@@]].              
          @@@@^                           =@@@^ \@@@@@@@@@@@@`                                @        @          @@@@@           ,@@@@`                =@@@^    @@@@@ /@@@@@@@@@@@@@@@@@@@\`          
          @@@@^                          .@@@@    ,@@@@@@@@@@@@`                              @       =/         =@@@@@.          =@@@@.               ,@@@/     @@@@@=@@@@@@[[[[[[[[..\@@@@@\         
          =@@@^                          /@@@`      ,@@@@@@@@@@@@`                           =/       =`         @@@@@@.          =@@@/                @@@@.     @@@@@.                  @@@@/         
          =@@@@                         =@@@^         .\@@@@@@@@@@\.                         =^       ^          =@@@`            =@@@^               =@@@^      @@@@@@                  @@@@@         
           @@@@^                        @@@@            .\@@@@@@@@@@^                       .@       ,                            =@@@`              .@@@@        @@@@@                 =@@@@`         
           =@@@@                       =@@@`               \@@@@@@@@@@.                     /^                               .*[[[@@@@               /@@@^        @@@@@                /@@@@`          
            \@@@^                     .@@@/                  \@@@@@@@@@`                   =@                                     @@@@ [\@].        ,@@@@         @@@@@              .@@@@@`           
             @@@@^                    =@@@.                    [@@@@@@@@^                 ,@`                                     @@@@     [@]      @@@@`         @@@@@             ,@@@@/             
              @@@@^                  ,@@@^                       ,@@@@@@@`               =@`                                      @@@@       ,@`   =@@@/          @@@@@           /@@@@@`              
               \@@@\                 /@@@.                         ,@@@@@@.             /@`                                       @@@@        ,@` .@@@@.          @@@@@        ,@@@@@@`                
                \@@@@`              ,@@@/                            @@@@@@@`         .@@`                                       .@@@\         @^ =@@@^           @@@@@      /@@@@@@`                  
                 ,@@@@\.            /@@@^                             @@@@@@@@\`     /@/                                         =@@@@.        @^,@@@@.           @@@@@    ,@@@@@@@@]                  
                   ,@@@@\.         ,@@@@                              ,@@@@@@@@@@\.,@@`                                          =@@@@        /@`/@@@^            @@@@@    \@@@@@@@@@@@@\`             
                     ,@@@@@`       =@@@^                                 @@@@@@@@@\`                                         		 =@@@@      ,@@`,@@@@             @@@@@      .[@@@@@@@@@@@.            
                       ,@@@@@\.    @@@@^                                   @@@@@@@@@@@                                  			   =@@@@    ]@@/  /@@@^             @@@@@                                
                          \@@@@@\`=@@@@`                                    @@@@@@@@@@                               					   =@@@@^]@@@`   .@@@@              @@@@@                               
                            .[@@@@@@@@@`                                ,/@@@@/@@@@@@@@\]                          						   =@@@@@@`      @@@@@              @@@@@                               
                                ,\@@@@@@@\]`                             /@@@@@@/ @@@@@@@@@].       											       @@@@@@^      @@@@@^              @@@@@                               
                                     \@@@@@@@@\                      /@@@@@@@@/   	\@@@@@@@@@\                           	   /@@@@@@/                            @@@                                              
                                         \@@@@@@@@\            /@@@@@@@@@@/        		\@@@@@@@@@@\                   		  /@@@@@@/                                 @@                                      
                                                 \@@@@@@@@@@@@@@@@/                    \@@@@@@@@@@@@\          		 /@@@@@@@@@/                                                                                                      
                                                                                          \@@@@@@@@@@@@\ 		/@@@@@@@@@/                                                                                                    
																																																	\@@@@@@@@@@@@/                                                                                                                                                    
                                                                                                                                                                                                                                                                      
                                                                                                                                                          .]]]]]]]]]]]..                                                     .]]]/@@@@^                               
     =@@@@@@@@@@@@@@@@@`                @@@@@@@@@@@@@@@@@\                                       /@@@@@@@@@@@@@@O                                  .]/@@@@@@@@@@@@@@@@@@@@@@@@O]].                                     O@@@@@@@@@@@@@@@^                              
     =@@@@@@@@@@@@@@@@@.                O@@@@@@@@@@@@@@@@@@.                                    /@@@@@@@@@@@@@@@^                               ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\].                              =@@@@@@@@@@@@@@@@@`                             
     =@@@@@@@@@@@@@@@@@.                =@@@@@@@@@@@@@@@@@@@.                                  /@@@@@@@@@@@@@@@@^                            ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\                          ,@@@@@@@@@@@@@@@@@@@.                            
     ,@@@@@@@@@@@@@@@@@                 =@@@@@@@@@@@@@@@@@@@@`                                =@@@@@@@@@@@@@@@@@^                          /@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^                          @@@@@@@@@@@@@@@@@@@@\                            
     .@@@@@@@@@@@@@@@@@                 =@@@@@@@@@@@@@@@@@@@@@^                              =@@@@@@@@@@@@@@@@@@^                        /@@@@@@@@@@@@@@@[.     .[[\@@@@@@@@@@@@@@@@@@@@@^                          =@@@@@@@@@@@@@@@@@@@@@^                           
     .@@@@@@@@@@@@@@@@@                 .@@@@@@@@@@@@@@@@@@@@@@\                            =@@@@@@@@@@@@@@@@@@@^                      ,@@@@@@@@@@@@@@`                .[@@@@@@@@@@@@@@@@.                         ,@@@@@@@@@@@@@@@@@@@@@@@^                          
      @@@@@@@@@@@@@@@@O                 .@@@@@@@@@@@@@@@@@@@@@@@\                          ,@@@@@@@@@@@@@@@@@@@@^                    ./@@@@@@@@@@@@@^                      .[@@@@@@@@@@@`                         .@@@@@@@@@@@@@@@@@@@@@@@@@`                         
      @@@@@@@@@@@@@@@@/                  @@@@@@@@@@@@@@@@@@@@@@@@@.                       ,@@@@@@@@@@@@@@@@@@@@@^                   ,@@@@@@@@@@@@@@`                           [@@@@@@@^                          /@@@@@@@@@@@@@@@@@@@@@@@@@@.                        
      @@@@@@@@@@@@@@@@^                  O@@@@@@@@@@@@@@@@@@@@@@@@@`                     .@@@@@@@@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@@.                              .\@@@@                          =@@@@@@@@@@@@@@@@@@@@@@@@@@@\                        
      O@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@@@@@@@@@@@@@@^                   .@@@@@@@@@@@@@@@@@@@@@@@^                 =@@@@@@@@@@@@@@.                                 .\@`                         .@@@@@@@@@@@@@^@@@@@@@@@@@@@@@^                       
      \@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@@,@@@@@@@@@@@@@^                 .@@@@@@@@@=@@@@@@@@@@@@@@^                ,@@@@@@@@@@@@@@`                                                               /@@@@@@@@@@@@^ .@@@@@@@@@@@@@@@^                      
      =@@@@@@@@@@@@@@@^                  =@@@@@@@@@@@@/ ,@@@@@@@@@@@@@\                /@@@@@@@@`=@@@@@@@@@@@@@@^               .@@@@@@@@@@@@@@^                                                               =@@@@@@@@@@@@`   .@@@@@@@@@@@@@@@`                     
      =@@@@@@@@@@@@@@@^                  ,@@@@@@@@@@@@^  =@@@@@@@@@@@@@@.             /@@@@@@@@` .@@@@@@@@@@@@@@^               O@@@@@@@@@@@@@@                                                               .@@@@@@@@@@@@`     ,@@@@@@@@@@@@@@@.                    
      =@@@@@@@@@@@@@@@^                  .@@@@@@@@@@@@.   =@@@@@@@@@@@@@@`           /@@@@@@@@^   @@@@@@@@@@@@@@^              =@@@@@@@@@@@@@@^                                                               /@@@@@@@@@@@.       ,@@@@@@@@@@@@@@\                    
      =@@@@@@@@@@@@@@@`                   @@@@@@@@@@@O     \@@@@@@@@@@@@@@`         =@@@@@@@@^    @@@@@@@@@@@@@@.              @@@@@@@@@@@@@@@                                                               =@@@@@@@@@@@.         ,@@@@@@@@@@@@@@^                   
      =@@@@@@@@@@@@@@@.                   O@@@@@@@@@@^      \@@@@@@@@@@@@@@^       =@@@@@@@@^     O@@@@@@@@@@@@@.             =@@@@@@@@@@@@@@^                                                              ,@@@@@@@@@@/            ,@@@@@@@@@@@@@@^                  
      =@@@@@@@@@@@@@@@.                   =@@@@@@@@@@.       O@@@@@@@@@@@@@@\     =@@@@@@@@/      O@@@@@@@@@@@@@.             /@@@@@@@@@@@@@@^                                                              @@@@@@@@@@/              =@@@@@@@@@@@@@@`                 
      ,@@@@@@@@@@@@@@@                    =@@@@@@@@@O        .@@@@@@@@@@@@@@@@.  ,@@@@@@@@/       =@@@@@@@@@@@@@.            .@@@@@@@@@@@@@@@`                                                             =@@@@@@@@@^                =@@@@@@@@@@@@@@.                
      .@@@@@@@@@@@@@@@                    =@@@@@@@@@^         .@@@@@@@@@@@@@@@@.,@@@@@@@@@.       =@@@@@@@@@@@@@             ,@@@@@@@@@@@@@@@.                                                            ,@@@@@@@@@^                  =@@@@@@@@@@@@@\                
      .@@@@@@@@@@@@@@@                    =@@@@@@@@@`          ,@@@@@@@@@@@@@@@@@@@@@@@@@.        =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@`                                                            @@@@@@@@@`                    =@@@@@@@@@@@@@^               
       @@@@@@@@@@@@@@O                    .@@@@@@@@@            ,@@@@@@@@@@@@@@@@@@@@@@@`         =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@^                                                           =@@@@@@@@`                      \@@@@@@@@@@@@@^              
       @@@@@@@@@@@@@@^                     @@@@@@@@^             =@@@@@@@@@@@@@@@@@@@@@`          =@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@^                                                          ,@@@@@@@@.                        \@@@@@@@@@@@@@`             
       @@@@@@@@@@@@@@^                     O@@@@@@@^              =@@@@@@@@@@@@@@@@@@@^           .@@@@@@@@@@@@@             =@@@@@@@@@@@@@@@@                                                         .@@@@@@@@@@@@\]]`.                  \@@@@@@@@@@@@@.            
       O@@@@@@@@@@@@@^                     =@@@@@@@                =@@@@@@@@@@@@@@@@@^             @@@@@@@@@@@@@             =@@@@@@@@@@@@@@@@^                                                        /@@@@@@@@@@@@@@@@@@@@@@@@@\]]`.      @@@@@@@@@@@@@\            
       \@@@@@@@@@@@@@^                     =@@@@@@^                 \@@@@@@@@@@@@@@@^              @@@@@@@@@@@@O             .@@@@@@@@@@@@@@@@@                                                       =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^           
       =@@@@@@@@@@@@@^                     =@@@@@@^                  \@@@@@@@@@@@@@/               O@@@@@@@@@@@O              \@@@@@@@@@@@@@@@@^                                                     .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/[@@@@@@@@@@@@@`          
       =@@@@@@@@@@@@@^                     =@@@@@@.                  .@@@@@@@@@@@@/                \@@@@@@@@@@@O              .@@@@@@@@@@@@@@@@@^                                                    /@@@@@@@@@@@@@@@@@@@@@@@@@@O[[[.         .@@@@@@@@@@@@@.         
       =@@@@@@@@@@@@@^                     .@@@@@/                    .@@@@@@@@@@@.                =@@@@@@@@@@@^               ,@@@@@@@@@@@@@@@@@\                                                  =@@@@@@@@@@@@@@@@/[[`.                     .@@@@@@@@@@@@@         
       =@@@@@@@@@@@@@.                      @@@@@^                     ,@@@@@@@@@.                 =@@@@@@@@@@@^                ,@@@@@@@@@@@@@@@@@@`                                               .@@@@@O[[[.                                  ,@@@@@@@@@@@@\        
       =@@@@@@@@@@@@@.                      @@@@@.                      ,@@@@@@@`                  =@@@@@@@@@@@^                 .\@@@@@@@@@@@@@@@@@\.                                             O@@@@`                                        ,@@@@@@@@@@@@^       
       =@@@@@@@@@@@@@.                      \@@@O                        =@@@@@`                   =@@@@@@@@@@@^                   ,@@@@@@@@@@@@@@@@@@@`                                          =@@@@.                                          ,@@@@@@@@@@@@`      
       ,@@@@@@@@@@@@@                       =@@@^                         =@@@^                    ,@@@@@@@@@@@^                     ,@@@@@@@@@@@@@@@@@@@\.                                      ,@@@@.                                            ,@@@@@@@@@@@@.     
       .@@@@@@@@@@@@@                       =@@@`                          =@^                     .@@@@@@@@@@@^                       .[@@@@@@@@@@@@@@@@@@@\`                                   @@@/                                               =@@@@@@@@@@@@     
       .@@@@@@@@@@@@@                       =@@@                                                    @@@@@@@@@@@^                          .[@@@@@@@@@@@@@@@@@@@@\].                             =@@/                                                 =@@@@@@@@@@@\    
        @@@@@@@@@@@@O                       .@@^                                                    @@@@@@@@@@@^                              .[\@@@@@@@@@@@@@@@@@@@@\].                       ,@@^                                                   =@@@@@@@@@@@^   
        @@@@@@@@@@@@^                        @@^                                                    O@@@@@@@@@@^                                    ,[\@@@@@@@@@@@@@@@@@@@@O]`.               .@@`                                                     =@@@@@@@@@@@`  
        @@@@@@@@@@@@^                        @@                                                     \@@@@@@@@@@^                                           .,[[O@@@@@@@@@@@@@@@@@@@O]].       =@`                                                       \@@@@@@@@@@@. 
                                                                                                                                                                          ..,[[[[[[[[[[[`                                                                             
                                                                                                                                                                                                                                                                      

*/

#include "rm_auto_outpost/outpost_solver.hpp"
#include "rm_utils/logger/log.hpp"
#include <angles/angles.h>

namespace fyt::auto_outpost
{
    OutpostSolver::OutpostSolver()
    {
        trajectory_compensator_ = CompensatorFactory::createCompensator("ideal");
        trajectory_compensator_->iteration_times = 20;
        trajectory_compensator_->velocity = 15.8;
        trajectory_compensator_->gravity = 9.8;
        trajectory_compensator_->resistance = 0.001;

        outpost_interval = 800;
        have_detecte = false;
        get_center = false;
        waitingToshut = false;

        last_sleep_time = -1;
    }

    rm_interfaces::msg::GimbalCmd OutpostSolver::solve(const rm_interfaces::msg::Armors::SharedPtr armors_msg,const double IMU_pitch,const double IMU_yaw)
    {
        rm_interfaces::msg::GimbalCmd gimbal_cmd;
        gimbal_cmd.yaw = 0;
        gimbal_cmd.pitch = 0;
        gimbal_cmd.fire_advice = false;

        static cv::Point3d shootCenter = cv::Point3d(0,0,0);

        int dians_ = -1;
//==================================================================有识别到了装甲板则进下面函数=========================================================================================//
        if(!armors_msg->armors.empty()){
            auto target_armor = armors_msg->armors[0];
            dians_ = calculateDistanceToCenter(cv::Point2f(target_armor.pose_pic.position.x, target_armor.pose_pic.position.y)) * std::abs(target_armor.pose.position.x);
            // std::cout<<"dians_:"<<dians_<<std::endl;
            ArmorBlob a_;
            a_.x = target_armor.pose.position.x;
            a_.y = target_armor.pose.position.y;
            a_.z = target_armor.pose.position.z;
            armors_set.push_back(a_);

            if(armors_set.size()>31){
                armors_set.pop_back();
                auto max = std::max_element(armors_set.begin(), armors_set.end());
                armors_set.erase(max);
            }
        }
//=======================================================================以下算法无论有无识别到装甲板都会跑==============================================================================//

        // 获取现在的时间戳
        auto now = std::chrono::steady_clock::now();
 
        //armors_set是所有识别到的装甲板集合  此处是通过平均值计算旋转中心的三维坐标
        for (auto a: armors_set) {
            shootCenter += cv::Point3d(a.x, a.y, a.z);
        }
        if (armors_set.size() != 0){
            shootCenter = shootCenter / (int) armors_set.size();
        }

        bool shootable = false;
        int sleep_time = -1;

        //若进了以下判断则认为已经拟合完旋转中心
        if(armors_set.size()>=30){
            get_center = true;

            //计算到旋转中心的pitch、yaw并赋值发送下位机
            double yaw,pitch;
            Eigen::Vector3d target_position = {shootCenter.x, shootCenter.y, shootCenter.z};
            calcYawAndPitch(target_position, yaw, pitch);
            yaw = yaw * 180 / CV_PI;
            pitch = -pitch * 180 / CV_PI;
            gimbal_cmd.yaw = yaw;
            gimbal_cmd.pitch = pitch;
            gimbal_cmd.distance = dians_;
            //此处的距离是装甲板在图像上到图像中心的距离，并且x方向的权重较高

            //弹丸飞行时间
            flying_time = trajectory_compensator_->getFlyingTime(target_position);

            //拟合三块装甲板的时间差
            if(lostInShootZone >= 3 && !markLast){
                std::chrono::steady_clock::duration sum = std::chrono::steady_clock::duration::zero();
                for (const auto &timestamp: time) {
                    sum += timestamp.time_since_epoch();
                }
                if (time.size()) {
                    std::chrono::steady_clock::duration average = sum / time.size();
                    auto average_ms = std::chrono::duration_cast<std::chrono::milliseconds>(average);
                    timeInZone.push_back(average_ms);
                }
                time.clear();
                markLast = true;
            }

            //这两个是云台pitch、yaw当前值和目标值的差值
            double yaw_diff = std::fabs(IMU_yaw-yaw);
            double pitch_diff = std::fabs(IMU_pitch-pitch);

            //若进了以下判断则认为云台转到了目标值附近并且装甲板转到了枪口朝向中心的附近
            if(dians_ < 50 && yaw_diff<=5 && pitch_diff<=5){
                lostInShootZone = 0;
                markLast = false;
                time.push_back(now);

                //若进了以下判断则认为已经拟合完并获取了前哨站两块装甲板之间的时间间隔 average_ms
                if (timeInZone.size() >= 3) {
                    // 计算timeInZone相邻时间之间差值的平均值
                    std::chrono::steady_clock::duration sum = std::chrono::steady_clock::duration::zero();
                    sum = timeInZone[timeInZone.size()-1] - timeInZone[timeInZone.size()-3];
                    std::chrono::steady_clock::duration average = sum / 2; // 只用最近两个周期的时间进行拟合
                    auto average_ms = std::chrono::duration_cast<std::chrono::milliseconds>(average);
                    if(!waitingToshut){
                        shootable = true;
                    }
                    
                    if(average_ms.count()>950){
                        RCLCPP_INFO(rclcpp::get_logger("outpost_solver"),"average_ms:%ld",average_ms.count());
                        
                        if(last_sleep_time != -1){
                            sleep_time = last_sleep_time;
                        }
                        else{
                            shootable = false;
                        }
                        
                    }
                    else{
                        sleep_time = (int)(1.0 * average_ms.count() - flying_time * 1000);
                        last_sleep_time = sleep_time;
                    }
                    
                }
            }
            else if(dians_ > 100){
                lostInShootZone++;
            }
        }

        // 设置打弹
        if(shootable)
        {
            waitingToshut = true;
            std::cout<<"成功触发,将在"<<sleep_time<<"ms之后发弹"<<std::endl;
            std::thread([this, sleep_time, &gimbal_cmd, &shootable]() {
                // 延迟击打
                std::this_thread::sleep_for(std::chrono::milliseconds(sleep_time));
                gimbal_cmd.fire_advice = true;
                waitingToshut = false;
            }).detach();
        }

        // std::cout<<armors_msg->armors[0].selfyaw<<std::endl;

        return gimbal_cmd;
    }

    rm_interfaces::msg::GimbalCmd OutpostSolver::old_solve(const rm_interfaces::msg::Armors::SharedPtr armors_msg){
        double Camera_yaw,Camera_pitch;
        rm_interfaces::msg::GimbalCmd gimbal_cmd;
        gimbal_cmd.yaw = 0;
        gimbal_cmd.pitch = 0;
        gimbal_cmd.fire_advice = false;
        calcCameraYawAndPitch(Eigen::Vector3d{-armors_msg->armors[0].pose_camera.position.x, armors_msg->armors[0].pose_camera.position.z, -armors_msg->armors[0].pose_camera.position.y},
                              Camera_yaw,
                              Camera_pitch);

        // 装甲板经过正中心则开始计算时间间隔准备发弹
        if ((!have_detecte) && (Camera_pitch <= 1.5))
        {
            if (abs(Camera_yaw) <= 0.25)
            {
                double yaw, pitch;
                Eigen::Vector3d target_position = {armors_msg->armors[0].pose.position.x, armors_msg->armors[0].pose.position.y, armors_msg->armors[0].pose.position.z};
                calcYawAndPitch(target_position, yaw, pitch);
                flying_time = trajectory_compensator_->getFlyingTime(target_position);
                gimbal_cmd.yaw = yaw;
                gimbal_cmd.pitch = pitch;
            }
            if (abs(Camera_yaw) <= 0.2)
            {
                have_detecte = true;
                start = std::chrono::steady_clock::now();
            }
        }

        double elapsed_ms = 3500;

        if (have_detecte)
        {
            end = std::chrono::steady_clock::now();
            elapsed_ms = std::chrono::duration<double, std::milli>(end - start).count();
        }

        if (AutoFireControl(elapsed_ms))
        {
            gimbal_cmd.fire_advice = true;
            have_detecte = false;
        }

        if (elapsed_ms >= 4000 && have_detecte)
        {
            have_detecte = false;
        }

        return gimbal_cmd;
    }

    void OutpostSolver::calcCameraYawAndPitch(const Eigen::Vector3d &p, double &yaw, double &pitch) const noexcept
    {
        // Calculate Camera yaw and pitch
        yaw = atan2(p.y(), p.x());
        pitch = atan2(p.z(), p.head(2).norm());
    }

    void OutpostSolver::calcYawAndPitch(const Eigen::Vector3d &p,
                                        double &yaw,
                                        double &pitch) const noexcept
    {
        // Calculate yaw and pitch
        yaw = atan2(p.y(), p.x());
        pitch = atan2(p.z(), p.head(2).norm());

        if (double temp_pitch = pitch; trajectory_compensator_->compensate(p, temp_pitch))
        {
            pitch = temp_pitch;
        }
    }

    bool OutpostSolver::AutoFireControl(const double TimeDetecteToNow)
    {
        if (!have_detecte)
        {
            return false;
        }

        double All_FireDelay = outpost_interval + flying_time;
        if (abs(TimeDetecteToNow - All_FireDelay) <= 20)
        {
            return true;
        }
        return false;
    }

    void OutpostSolver::Init()
    {
        have_detecte = false;
        waitingToshut = false;
        time.clear();
        timeInZone.clear();
        armors_set.clear();
        last_sleep_time = -1;
    }

    double OutpostSolver::orientationToYaw(const geometry_msgs::msg::Quaternion &q) noexcept
    {
        // Get armor yaw
        tf2::Quaternion tf_q;
        tf2::fromMsg(q, tf_q);
        double roll, pitch, yaw;
        tf2::Matrix3x3(tf_q).getRPY(roll, pitch, yaw);
        // Make yaw change continuous (-pi~pi to -inf~inf)
        // yaw = last_yaw_ + angles::shortest_angular_distance(last_yaw_, yaw);
        // last_yaw_ = yaw;
        return yaw;
    }

    float OutpostSolver::calculateDistanceToCenter(const cv::Point2f &image_point) const noexcept {

        float cx = camera_matrix.at<double>(0, 2);
        float cy = camera_matrix.at<double>(1, 2);
        double p = 1;

        auto distance = p * std::fabs(image_point.x - cx) + (1-p) * std::fabs(image_point.y - cy);
        return distance;
    }

}